@{
    ViewData["Title"] = "Home Page";
}

<div class="container">

    <!-- Row with dropdown and button -->
    <div class="row mb-4">
        <div class="col-6">
            <label for="timeSelectDropdown">Choose a Time Range</label>
            <div class="custom-select">
                <select class="custom-select-input" id="timeSelectDropdown">
                    <option value="30m" selected>Last 30 min</option>
                    <option value="24h">24 hours</option>
                    <option value="3d">Last 3 days</option>
                    <option value="7d">Last 7 days</option>
                    <option value="30d">Last 1 month</option>
                </select>
                <span class="custom-select-arrow" aria-hidden="true"></span>
            </div>
            <div class="col-2 mt-26px">
                <button id="fetchInsight" class="btn btn-primary">Fetch</button>
            </div>
        </div>
    </div>

    <!-- Table -->
    <table class="table table-fixed">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>CorrelationId</th>
                <th>EntityName</th>
                <th>Action</th>
                <th>Status</th>
                <th>QueueName</th>
            </tr>
        </thead>
        <tbody id="logTableBody">
            <!-- rows injected dynamically -->
        </tbody>
    </table>

    <!-- Pagination -->
    <nav aria-label="Pagination">
        <label for="rowsPerPageSelect">Rows per page:</label>
        <select id="rowsPerPageSelect">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="5">5</option>
        </select>
        <ul class="pagination pagination-segment-start"></ul>
    </nav>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        let rowsPerPage = parseInt($("#rowsPerPageSelect").val());
        let currentPage = 1;
        let allLogs = [];

        function fetchLogs() {
            let range = $("#timeSelectDropdown").val();
            $.get(`/api/logs?range=${range}`, function (data) {
                allLogs = data || [];
                currentPage = 1;
                renderTable();
                buildPagination();
            }).fail(function () {
                $("#logTableBody").html("<tr><td colspan='6'>Failed to fetch logs</td></tr>");
                $(".pagination").empty();
            });
        }

        function renderTable() {
            $("#logTableBody").empty();

            if (!allLogs || allLogs.length === 0) {
                $("#logTableBody").html("<tr><td colspan='6'>No records found</td></tr>");
                return;
            }

            let start = (currentPage - 1) * rowsPerPage;
            let end = start + rowsPerPage;
            let pageData = allLogs.slice(start, end);

            $.each(pageData, function (i, log) {
                $("#logTableBody").append(`
                    <tr>
                        <td>${log.timestamp}</td>
                        <td>${log.correlationId}</td>
                        <td>${log.entityName}</td>
                        <td>${log.action}</td>
                        <td>${log.status}</td>
                        <td>${log.queueName}</td>
                    </tr>
                `);
            });
        }

        function buildPagination() {
            let pageCount = Math.ceil(allLogs.length / rowsPerPage);
            let pagination = $(".pagination");
            pagination.empty();

            if (pageCount <= 1) return; // hide pagination if only 1 page

            pagination.append('<li class="page-item"><a href="#" class="page-link prev">Previous</a></li>');

            for (let i = 1; i <= pageCount; i++) {
                pagination.append(`<li class="page-item ${i === currentPage ? "active" : ""}">
                    <a href="#" class="page-link page-num" data-page="${i}">${i}</a></li>`);
            }

            pagination.append('<li class="page-item"><a href="#" class="page-link next">Next</a></li>');
        }

        // Event handlers
        $(document).on("click", ".page-num", function (e) {
            e.preventDefault();
            currentPage = parseInt($(this).data("page"));
            renderTable();
            buildPagination();
        });

        $(document).on("click", ".prev", function (e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                renderTable();
                buildPagination();
            }
        });

        $(document).on("click", ".next", function (e) {
            e.preventDefault();
            let pageCount = Math.ceil(allLogs.length / rowsPerPage);
            if (currentPage < pageCount) {
                currentPage++;
                renderTable();
                buildPagination();
            }
        });

        $("#rowsPerPageSelect").on("change", function () {
            rowsPerPage = parseInt($(this).val());
            currentPage = 1;
            renderTable();
            buildPagination();
        });

        $("#fetchInsight").on("click", function () {
            fetchLogs();
        });

        // Initial load
        fetchLogs();
    });
</script>
